---
description: 'フロントエンド: 厳格な境界 (UI→Model→API→shared/api→BFF) + サーバー専用安全性'
globs: ['frontend/**/*']
alwaysApply: false
---

# フロントエンドアーキテクチャ (厳格)

## 依存方向 (絶対に破らない)

```
UI (modules/*/ui)
  → PageModel (modules/*/model)
    → API (modules/*/api)
      → shared/api
        → BFF (app/api)
          → Backend (/api/v1)
```

## ディレクトリ構造

### `app/` — Next.js App Router

| パス                | 役割                                     |
| ------------------- | ---------------------------------------- |
| `app/(public)/`     | 公開ページ (auth/login, auth/register) |
| `app/(onboarding)/` | 初回セットアップフロー                    |
| `app/(app)/`        | 認証済みメインアプリ                   |
| `app/api/`          | **BFF** — バックエンドへのプロキシ               |
| `app/layout.tsx`    | ルートレイアウト                              |
| `app/providers.tsx` | クライアントプロバイダー (React Query等)     |

- `(group)` はURLに表示されない。URLの衝突を防ぐ。

### `modules/` — 機能モジュール

各機能は分離されたサブディレクトリを持つ:

| サブディレクトリ      | 役割                                                      |
| ----------- | --------------------------------------------------------- |
| `ui/`       | Reactコンポーネント (UI層)                               |
| `model/`    | PageModelフック (`useXxxPageModel`) + Zodスキーマ          |
| `api/`      | `clientApiFetch`経由のBFF呼び出し                            |
| `contract/` | 型定義 / Zodスキーマ                            |
| `index.ts`  | **クライアントセーフなエクスポートのみ**                              |
| `server.ts` | **サーバー専用エクスポート** (`import 'server-only'` 必須) |

### `shared/` — 共有ユーティリティ

| パス                      | 役割                                     |
| ------------------------- | ---------------------------------------- |
| `shared/api/client.ts`    | クライアントfetchラッパー (BFF `/api/*`へ)   |
| `shared/api/bffServer.ts` | サーバーサイドfetch                        |
| `shared/api/proxy.ts`     | BFFプロキシユーティリティ (サーバー専用)          |
| `shared/api/errors.ts`    | エラー正規化                      |
| `shared/api/contracts/`   | 共有Zodスキーマ                       |
| `shared/lib/query/`       | TanStack Query設定                    |
| `shared/ui/`              | 共通UI (EmptyState, ErrorState等) |

### `components/ui/` — shadcn/uiコンポーネント

再利用可能なベースUIコンポーネント (button, card, input等)

## レイヤールール (必須)

### UI層

- PageModelのみをインポート。**APIを直接呼び出してはならない。**

### PageModel層

- `useXxxPageModel`フックを含む。
- API呼び出し + 状態をオーケストレート。

### API層 (`modules/*/api`)

- すべての機能API呼び出しをここに配置。
- `shared/api/client.ts`から`clientApiFetch`を使用。

### shared/api層

- Fetchとエラー正規化のみ。**機能ロジックは含まない。**

### BFF層 (`app/api`)

- バックエンドへのリクエストをプロキシ。
- Cookie / Set-Cookieを転送。
- **フロントエンドからバックエンドへの直接呼び出し禁止。** 常にBFF `/api/*`経由。

## サーバー/クライアント混在防止 (必須)

- サーバー専用モジュールは`import 'server-only'`で開始。
- `modules/*/server.ts`はサーバー専用のみ。
- `modules/*/index.ts`はクライアントセーフのみをエクスポート (サーバー専用をエクスポートしてはならない)。
- クライアントコンポーネントは`next/headers`、`server-only`、サーバー専用モジュールをインポートしてはならない。

## データフロー

```
┌─────────────────────────────────────────────────────────┐
│ ブラウザ                                                │
├─────────────────────────────────────────────────────────┤
│  UIコンポーネント (modules/*/ui/)                        │
│       ↓ 使用                                             │
│  PageModelフック (modules/*/model/useXxxPageModel.ts)   │
│       ↓ 呼び出し                                         │
│  機能API (modules/*/api/xxxClient.ts)                   │
│       ↓ 使用                                             │
│  clientApiFetch (shared/api/client.ts)                  │
│       ↓ fetch("/api/...")                               │
├─────────────────────────────────────────────────────────┤
│  BFFルートハンドラー (app/api/.../route.ts)  ← Next.js   │
│       ↓ プロキシ                                         │
├─────────────────────────────────────────────────────────┤
│  バックエンドAPI (/api/v1/...)                ← FastAPI   │
└─────────────────────────────────────────────────────────┘
```
