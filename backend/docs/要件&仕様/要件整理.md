いいですね、じゃあ修正・追加点を反映した形で、要件だけを整理し直します ✅

1. ユーザー / アカウント & プラン
   ユーザーはアカウントを作成・認証できること

サインアップ / ログイン / ログアウト / リフレッシュ / 退会
ユーザーはプラン情報を持つこと

TRIAL / FREE / PAID
新規ユーザーは 登録時点から 7 日間の TRIAL とすること

試用期間終了後：

Stripe で課金したユーザー → PAID
課金しないユーザー → FREE 2. 課金要件（MVP として必須）
支払い処理は Stripe を利用すること

プランごとの機能制限：

TRIAL / PAID ユーザーのみ利用可能な機能

栄養計算（MealNutritionSummary / DailyNutritionSummary の生成）
日次レポート生成（DailyNutritionReport）
提案機能（MealRecommendation）
FREE ユーザー：

食事記録自体（FoodEntry）は継続して利用可能
上記「課金が必要な機能」は利用不可、もしくは制限付き 3. プロフィール
ユーザーはプロフィールを登録・更新できること

性別 / 生年月日 / 身長 / 体重 / プロフィール画像
プロフィールには meals_per_day（1 日のメイン食事回数）を必ず設定すること

例：2 / 3 / 4
meals_per_day は 記録完了判定の前提条件 となること

4. 栄養ターゲット（Target）
   4-1. ターゲット定義
   ユーザーは栄養ターゲット（1 日分の 17 栄養素の目標値）を複数持てること
   ターゲット定義の上限は 5 個まで
   常に 1 つだけがアクティブ（Active Target） であること
   4-2. ターゲット生成・変更
   新しいターゲット定義の作成は LLM を利用して自動生成すること

Profile（性別/体重/身長など）＋目標（GoalType）＋活動レベルなどを入力に使う
ターゲットの「部分変更（微調整）」は 手動のみ有効 とし、

LLM による差分生成ではなく、ユーザーが値を直接編集する仕様とすること
4-3. 日次スナップショット（DailyTargetSnapshot）
各日付について、その日のターゲット値を表す DailyTargetSnapshot を持てること

日付ごとの扱い：

当日（今日）

アプリ内で「今日のターゲット」を参照するときは、
常に現在のアクティブターゲット（Active Target）を利用すること
過去日（昨日以前）

日付が変わるタイミング（例：深夜の JOB）で、

「その時点のアクティブターゲット」を 前日分の Snapshot として固定化 すること
一度 Snapshot 化された日付以降のターゲット値は 変更不可 とすること
JOB 要件：

毎日 1 回、日付を跨ぐタイミングで実行される JOB が

その時点の Active Target から「昨日の日付」の DailyTargetSnapshot を生成・保存すること
これにより、過去日については常に Snapshot ベースの固定値が参照されること

5. 食事記録（FoodEntry）
   ユーザーは 1 品単位で食事を記録できること

各 FoodEntry は次を持つこと：

date

meal_type: "main" or "snack"

meal_index:

main の場合: 1..meals_per_day の整数（1 回目/2 回目/…）
snack の場合: None
name: 食品名・メニュー名

量指定（いずれか必須）：

amount_value + amount_unit
serving_count
任意のメモ（note）

食事記録はソフトデリート対応とし、deleted_at が設定されたエントリは通常の取得・集計・判定から除外すること

6. 栄養計算：Meal / Daily
   6-1. 1 食分（MealNutritionSummary）
   (user_id, date, meal_type, meal_index) ごとに
   1 食分の栄養サマリ（17 栄養素など）をもてること
   対応する FoodEntry 群をもとに、
   NutritionEstimator（LLM or 外部サービス or スタブ）で栄養を推定すること
   この機能は TRIAL / PAID のみ利用可能 とすること
   6-2. 1 日分（DailyNutritionSummary）
   (user_id, date) ごとに、その日の全ての MealNutritionSummary を合計した値を持てること

合計値要件：

栄養素コードごとに value を合計
Meal が 0 件でも nutrients=[] の Daily を保存（0 サマリ）
食事記録の更新・削除時には 該当日付の Daily を再計算して整合性を保つこと

更新：変更前の日付 + 変更後の日付を再計算
削除：削除されたエントリの date を再計算
Daily の再計算（栄養計算）も TRIAL / PAID のみ利用可 とすること

7. 記録完了判定（DailyLogCompletion）
   (user_id, date) ごとに、その日の記録が「完了」しているか判定できること
   完了条件：

Profile が存在し、meals_per_day = N (>=1) が設定されている

その日の FoodEntry のうち、

meal_type == "main"
deleted_at is None
の meal_index を集めたときに、
集合 {1, 2, ..., N} をすべて含んでいる

→ 判定結果として is_completed / filled_indices / missing_indices を得られること。

エラー扱い：

Profile が存在しない場合 → 記録完了を判定できないエラー
meals_per_day < 1 → 無効な設定としてエラー 8. 日次レポート（DailyNutritionReport）
(user_id, date) ごとに最大 1 件の日次レポートを持つこと

レポート内容：

summary: 1 日の総評
good_points: list[str]
improvement_points: list[str]
tomorrow_focus: list[str]
生成条件：

対象日が 記録完了している日 であること
同じ (user_id, date) に既にレポートが存在しないこと
レポート生成機能は TRIAL / PAID のみ利用可能 とすること
生成の材料：

Profile
DailyTargetSnapshot（対象日のターゲット：過去日は Snapshot、当日は Active Target）
DailyNutritionSummary（対象日の実績）
その日の MealNutritionSummary 一覧 9. 提案機能（MealRecommendation）
ユーザーは、過去のレポートをもとにした食事提案を受け取れること

提案は以下を含む：

user_id
generated_for_date: この日までの履歴をもとにした提案であることを示す日付
body: 提案本文
tips: list[str]: 実行可能なアクションの箇条書き
生成条件：

直近 N 日分（現状 5 日）の DailyNutritionReport が存在すること
→ 足りない場合は提案を生成しない（エラー or スキップ）
generated_for_date（通常は「今日」）に対する提案が既に存在しないこと
提案生成機能は TRIAL / PAID のみ利用可能 とすること
生成の材料：

Profile
アクティブなターゲット定義（あれば）
直近 5 日分の DailyNutritionReport 10. JOB による自動実行
10-1. ターゲットスナップショット JOB
毎日 1 回、日付を跨ぐタイミングで実行されること

その時点の Active Target を用いて、

「昨日」の DailyTargetSnapshot を生成・保存すること
これにより、過去日のターゲット値が固定され、あとから変更されないこと

10-2. 提案生成 JOB
毎日 1 回、全アクティブユーザーに対して実行されること

各ユーザーについて：

直近 5 日分の DailyNutritionReport が揃っているか確認
本日の MealRecommendation が既に存在する場合はスキップ
条件を満たす TRIAL / PAID ユーザーに対して、提案を自動生成・保存すること
これが、ターゲット仕様の修正と課金要件の追加を反映した、現時点の要件一覧です ✅
このまま上流仕様メモや README の「機能要件」のベースとして使えるはずです。
