了解。上記の設計（ABCDE / strict boundary）を **そのまま「実装タスク」**に分解して、**迷わず順番に潰せる Backlog** に落とします。
（最優先：Today を “通す” → 次に C/E を足す）

---

# Today（ABCDE）実装タスク Backlog

## Epic: Today（集約画面）を成立させる

### Done 定義（共通）

- UI は **today/model** しか import しない
- Model は **feature api** を呼ぶ
- feature api は **shared/api/clientApiFetch** のみを利用
- contract は他レイヤーを import しない
- BFF は **server-only proxy** 経由で backend に転送
- 404 を **必要に応じて null で握る**（Model が画面分岐）

---

## Phase 0: 依存前提（チェック）

### T0-1 Providers / QueryClientProvider の確認（必須）

- [ ] `src/app/providers.tsx` が `QueryClientProvider` をラップしている
- [ ] `src/app/layout.tsx` が `<Providers>` を確実に通している
- [ ] Today UI が `useQuery` を使うファイルは **必ず 'use client'**

**AC**

- TodayPage を表示した時に `No QueryClient set` が出ない

---

## Phase 1: BFF ルートを揃える（最優先）

> まず「フロント → /api/\* → backend」が全部通る状態にする

### T1-1 BFF: meal-items（GET/POST）

- [ ] `src/app/api/meal-items/route.ts` 作成

  - GET `/api/v1/meal-items?date=...` へ proxy
  - POST `/api/v1/meal-items` へ proxy

**AC**

- curl / ブラウザで `/api/meal-items?date=YYYY-MM-DD` が backend と同じ JSON を返す

### T1-2 BFF: meal-items entry（PATCH/DELETE）

- [ ] `src/app/api/meal-items/[entry_id]/route.ts` 作成

  - PATCH `/api/v1/meal-items/{entry_id}`
  - DELETE `/api/v1/meal-items/{entry_id}`

**AC**

- PATCH/DELETE が backend の status / body を透過する

### T1-3 BFF: nutrition meal（GET）

- [ ] `src/app/api/nutrition/meal/route.ts` 作成

  - GET `/api/v1/nutrition/meal?...` へ proxy

**AC**

- `/api/nutrition/meal?...` が 200 を返し `meal` と `daily` を含む

### T1-4 BFF: daily report（GET/POST）

- [ ] `src/app/api/nutrition/daily/report/route.ts` 作成

  - GET `/api/v1/nutrition/daily/report?date=...`
  - POST `/api/v1/nutrition/daily/report`

**AC**

- GET 404 / 200 が backend と一致
- POST 201 / 400 / 409 が backend と一致

---

## Phase 2: Contract（meal / nutrition）

> Today は contract を持たない。各 feature に持たせる。

### T2-1 Meal contract

- [ ] `src/modules/meal/contract/mealContract.ts` 作成

  - `MealTypeSchema`
  - `MealItemRequestSchema`
  - `MealItemResponseSchema`
  - `MealItemListResponseSchema`

**AC**

- schema.parse が openapi の shape に一致

### T2-2 Nutrition contract（meal + daily report）

- [ ] `src/modules/nutrition/contract/nutritionContract.ts` 作成

  - `NutrientCodeSchema` / `NutrientSourceSchema`
  - `NutritionNutrientIntakeSchema`
  - `MealNutritionSummarySchema`
  - `DailyNutritionSummarySchema`
  - `MealAndDailyNutritionResponseSchema`
  - `DailyNutritionReportResponseSchema`

**AC**

- `/nutrition/meal` と `/nutrition/daily/report` のレスポンスが parse できる

---

## Phase 3: API client（meal / nutrition）

> API 層は `clientApiFetch` のみ。404 は必要に応じて握る。

### T3-1 mealClient

- [ ] `src/modules/meal/api/mealClient.ts` 作成

  - `listMealItemsByDate(date)`
  - `createMealItem(input)`
  - `updateMealItem(entryId, input)`
  - `deleteMealItem(entryId)`

**ルール**

- 200/201 は schema.parse
- 4xx/5xx は基本 throw（※一覧取得は 401 以外ほぼ throw で OK）

### T3-2 nutritionClient

- [ ] `src/modules/nutrition/api/nutritionClient.ts` 作成

  - `recomputeMealAndDaily({date, meal_type, meal_index})`
  - `getDailyReport(date)` → 404 は `null`
  - `generateDailyReport(date)` → 201 は parse / 409 は throw せず “既存” 扱いで OK（Model で refetch）

---

## Phase 4: Today Model（A/B/D をまず通す）

### T4-1 useTodayPageModel v0（A/B/D）

- [ ] `src/modules/today/model/useTodayPageModel.ts` 作成

  - 取得順：profile → activeTarget → mealItems
  - `gate: 'ok' | 'need_profile' | 'need_target'`
  - `mealsPerDay: number`（未設定は 3）
  - `sections`（main 1..N + snack への振り分け）
  - `isLoading/isError/errorMessage`

**AC**

- profile が null → need_profile
- activeTarget が null → need_target
- meal-items 0 件 → empty state 用に sections が空/または各枠空で返る

---

## Phase 5: Today UI（A/B/D を表示）

### T5-1 TodayPage v0（A/B/D）

- [ ] `src/modules/today/ui/TodayPage.tsx` 作成（`'use client'`）

  - Model だけ import
  - カード A（ヘッダ）
  - カード B（ActiveTarget）
  - カード D（Meal sections）
  - gate による表示分岐（need_profile/need_target）

### T5-2 Next.js page

- [ ] `src/app/(app)/today/page.tsx` 作成（server で OK）

  - `<TodayPage />` を返すだけ

**AC**

- Today が表示できる（A/B/D が最低限成立）

---

## Phase 6: C（日次サマリー）を追加

### T6-1 useTodayPageModel v1（C）

- [ ] nutrition query を追加

  - `recomputeMealAndDaily(date, main, 1)` を初期表示で呼ぶ
  - `enabled` は `gate==='ok'` & `mealItemsQuery.isSuccess` など安全条件
  - エラーは握って `dailySummary: null` に落とす（Today 自体は生かす）

### T6-2 Today UI に daily card を追加

- [ ] カード C：dailySummary 表示

  - null → “計算できませんでした” 表示

**AC**

- nutrition が落ちても Today が落ちない

---

## Phase 7: E（レポート）を追加

### T7-1 useTodayPageModel v2（E）

- [ ] `dailyReportQuery`（GET, 404→null）
- [ ] `generateReportMutation`（POST）

  - 成功/409 → `dailyReportQuery.refetch()`（または invalidate）

### T7-2 Today UI に report card を追加

- [ ] 404(null) → “生成する” ボタン
- [ ] 200 → レポート表示
- [ ] 400 → 条件不足メッセージ表示

**AC**

- レポート生成 → 表示まで一連が動く

---

# 実装の進め方（最短で “通す”）

- **最初のゴール**：Phase1〜5（A/B/D）までで Today を表示できる
- 次に **C（nutrition）**、最後に **E（daily report）**

---

このタスク分解でいきます。
次のメッセージで、**Phase1（BFF 4 本）をまとめてコード生成** → 次に **Phase2/3（contract/api）** → 次に **Phase4/5（today/model+ui）** の順で一気に貼り付け可能な形に出します。
